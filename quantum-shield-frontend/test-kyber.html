<!DOCTYPE html>
<html>
<head>
  <title>Kyber Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    #output {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    p {
      margin: 10px 0;
      line-height: 1.6;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
  </style>
</head>
<body>
  <h1>Kyber768 Browser Test</h1>
  <div id="output">Loading kyber-crystals...</div>

  <script>
    const kyber = require('./node_modules/kyber-crystals')
    const output = document.getElementById('output')

    async function test() {
      output.innerHTML = '<h2>Testing kyber-crystals...</h2>'

      try {
        // 1. æª¢æŸ¥å¯ç”¨æ–¹æ³•
        output.innerHTML += '<h3>Available methods:</h3>'
        output.innerHTML += `<p>typeof kyber: ${typeof kyber}</p>`
        output.innerHTML += `<p>Methods: ${Object.keys(kyber).join(', ')}</p>`

        // 2. ç”Ÿæˆå¯†é‘°å°
        output.innerHTML += '<h3>Generating keypair...</h3>'
        const { publicKey, privateKey } = await kyber.keyPair()
        output.innerHTML += `<p class="success">âœ… Keypair generated</p>`
        output.innerHTML += `<p>ğŸ“Š Public key: ${publicKey.length} bytes</p>`
        output.innerHTML += `<p>ğŸ“Š Private key: ${privateKey.length} bytes</p>`

        // 3. Encapsulate
        output.innerHTML += '<h3>Testing encryption...</h3>'
        const { cyphertext, secret } = await kyber.encrypt(publicKey)
        output.innerHTML += `<p class="success">âœ… Encryption successful</p>`
        output.innerHTML += `<p>ğŸ“Š Ciphertext: ${cyphertext.length} bytes</p>`
        output.innerHTML += `<p>ğŸ“Š Shared secret: ${secret.length} bytes</p>`

        // 4. Decapsulate
        output.innerHTML += '<h3>Testing decryption...</h3>'
        const decrypted = await kyber.decrypt(cyphertext, privateKey)
        output.innerHTML += `<p class="success">âœ… Decryption successful</p>`
        output.innerHTML += `<p>ğŸ“Š Decrypted secret: ${decrypted.length} bytes</p>`

        // 5. é©—è­‰
        const match = secret.every((val, i) => val === decrypted[i])
        output.innerHTML += `<p class="success">âœ… Secrets match: ${match}</p>`

        // 6. é¡¯ç¤ºæ ¼å¼
        output.innerHTML += '<h3>Format Check:</h3>'
        output.innerHTML += `<p>Public key type: ${publicKey.constructor.name}</p>`
        output.innerHTML += `<p>First 32 bytes (hex): ${Array.from(publicKey.slice(0, 32)).map(b => b.toString(16).padStart(2, '0')).join('')}</p>`

        // 7. é¡¯ç¤ºå¸¸é‡ï¼ˆå¾å¯¦éš›æ¸¬è©¦æ¨æ–·ï¼‰
        output.innerHTML += '<h3>ğŸ“Š Kyber768 Constants:</h3>'
        output.innerHTML += `<p>PUBLICKEYBYTES: ${publicKey.length}</p>`
        output.innerHTML += `<p>SECRETKEYBYTES: ${privateKey.length}</p>`
        output.innerHTML += `<p>CIPHERTEXTBYTES: ${cyphertext.length}</p>`
        output.innerHTML += `<p>SHAREDSECRETBYTES: ${secret.length}</p>`

        // 8. èˆ‡ Rust ç‰ˆæœ¬æ¯”è¼ƒ
        output.innerHTML += '<h3>Compatibility Check with Rust:</h3>'
        const rustConstants = {
          PUBLICKEYBYTES: 1184,
          SECRETKEYBYTES: 2400,
          CIPHERTEXTBYTES: 1088,
          SHAREDSECRETBYTES: 32
        }

        const matches = {
          publicKey: publicKey.length === rustConstants.PUBLICKEYBYTES,
          secretKey: privateKey.length === rustConstants.SECRETKEYBYTES,
          ciphertext: cyphertext.length === rustConstants.CIPHERTEXTBYTES,
          sharedSecret: secret.length === rustConstants.SHAREDSECRETBYTES
        }

        Object.entries(matches).forEach(([key, isMatch]) => {
          const status = isMatch ? 'âœ…' : 'âŒ'
          const className = isMatch ? 'success' : 'error'
          output.innerHTML += `<p class="${className}">${status} ${key}: ${isMatch ? 'MATCH' : 'MISMATCH'}</p>`
        })

        const allMatch = Object.values(matches).every(v => v)
        if (allMatch) {
          output.innerHTML += '<h2 class="success">ğŸ‰ All constants match! Frontend and Backend are compatible!</h2>'
        } else {
          output.innerHTML += '<h2 class="error">âš ï¸ Compatibility issue detected!</h2>'
        }

      } catch (e) {
        output.innerHTML += `<p class="error">âŒ Error: ${e.message}</p>`
        output.innerHTML += `<p class="error">Stack: ${e.stack}</p>`
        console.error(e)
      }
    }

    test()
  </script>
</body>
</html>
